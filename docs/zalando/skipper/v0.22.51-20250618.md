# v0.22.51

## release on 20250618

## description

## changes

Changes

Enabling OPA AST optimizations in Skipper to store AST values in in-memory store (<a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="3091387456" data-permission-text="Title is private" data-url="https://github.com/zalando/skipper/issues/3514" data-hovercard-type="pull_request" data-hovercard-url="/zalando/skipper/pull/3514/hovercard" href="https://github.com/zalando/skipper/pull/3514">#3514</a>)

<strong>Context:</strong>

With <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="2597787701" data-permission-text="Title is private" data-url="https://github.com/open-policy-agent/opa/issues/7125" data-hovercard-type="pull_request" data-hovercard-url="/open-policy-agent/opa/pull/7125/hovercard" href="https://github.com/open-policy-agent/opa/pull/7125">open-policy-agent/opa#7125</a> Open Policy

Agent introduced an option to read AST values from in-memory storage

instead of interfaces/slices.

When enabled it is expected to improve latency as this removes the time

spent converting raw data values to AST during policy evaluation. The

memory footprint of the store will increase, as processed AST values

would take more space in memory than the corresponding raw data values,

but overall memory usage of OPA might remain more stable over time, as

pre-converted data is shared across evaluations and isn't recomputed for

each evaluation.

With this PR, the option

<code>enable-open-policy-agent-data-preprocessing-optimization</code> is supported

as a Skipper configuration at OPA registry level. In other words, when

enabled it will be enabled for all the OPA systems running within the

same Skipper ingress.

Benchmark test results show huge improvments

A 1000 run of the benchmark comparison.

For the simple policy,

<a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/791850/456166179-b4a71b03-ed10-440f-bcd5-05a3e9d3dbaf.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTE4NTEyMDUsIm5iZiI6MTc1MTg1MDkwNSwicGF0aCI6Ii83OTE4NTAvNDU2MTY2MTc5LWI0YTcxYjAzLWVkMTAtNDQwZi1iY2Q1LTA1YTNlOWQzZGJhZi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwNzA3JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDcwN1QwMTE1MDVaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1iNDllZTM0YmI5ODcxM2YyZTQ1Yzc1NDJjMmI3NGVhZTE5ZjQzZTQ3ODJkNGYxNDBiZDljM2M2Y2VjMmZmNzkwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.jju6kXWHahcX9WYnrhuXDS41wLejmU__Aq4PGaYJv68"><img width="805" alt="image" src="https://private-user-images.githubusercontent.com/791850/456166179-b4a71b03-ed10-440f-bcd5-05a3e9d3dbaf.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTE4NTEyMDUsIm5iZiI6MTc1MTg1MDkwNSwicGF0aCI6Ii83OTE4NTAvNDU2MTY2MTc5LWI0YTcxYjAzLWVkMTAtNDQwZi1iY2Q1LTA1YTNlOWQzZGJhZi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwNzA3JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDcwN1QwMTE1MDVaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1iNDllZTM0YmI5ODcxM2YyZTQ1Yzc1NDJjMmI3NGVhZTE5ZjQzZTQ3ODJkNGYxNDBiZDljM2M2Y2VjMmZmNzkwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.jju6kXWHahcX9WYnrhuXDS41wLejmU__Aq4PGaYJv68" content-type-secured-asset="image/png" style="max-width: 100%; height: auto;"></a>

|           | ns/op _default | ns/op _optimized | B/op _default | B/op _optimized | allocs/op _default | allocs/op _optimized |
|-----------|----------------|------------------|---------------|-----------------|--------------------|----------------------|
| Median    | 24727.5        | 25016            | 18945         | 18961           | 308                | 309                  |
| Average   | 26727.107      | 27058.068        | 18945.996     | 18961.234       | 308                | 309                  |
| P99       | 37737.5        | 39558.05         | 18951         | 18967           | 308                | 309                  |
| Max       | 44914          | 49197            | 18953         | 18968           | 308                | 309                  |
| Min       | 23375          | 23899            | 18945         | 18961           | 308                | 309                  |
| Deviation | 3703.249928    | 3840.160723      | 1.550609038   | 0.9110840104    | 0                  | 0                    |

For the slightly complex policy,

<a target="_blank" rel="noopener noreferrer" href="https://private-user-images.githubusercontent.com/791850/456166799-c5cd93d2-38cc-47ef-b6b4-f31cad91c461.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTE4NTEyMDUsIm5iZiI6MTc1MTg1MDkwNSwicGF0aCI6Ii83OTE4NTAvNDU2MTY2Nzk5LWM1Y2Q5M2QyLTM4Y2MtNDdlZi1iNmI0LWYzMWNhZDkxYzQ2MS5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwNzA3JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDcwN1QwMTE1MDVaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1jMjdmMDUyOWQ0ZGE2MjgxNTY5MmUwYTczZWViZDJkYmE5NDIxNzVmZTEwNDY4YmViYTM1MGIxZmU1N2IyN2I1JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.7EkS1RhCXCmuM87PWwc_wZK1eUO--OQkjKhORsWybOM"><img width="778" alt="image" src="https://private-user-images.githubusercontent.com/791850/456166799-c5cd93d2-38cc-47ef-b6b4-f31cad91c461.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTE4NTEyMDUsIm5iZiI6MTc1MTg1MDkwNSwicGF0aCI6Ii83OTE4NTAvNDU2MTY2Nzk5LWM1Y2Q5M2QyLTM4Y2MtNDdlZi1iNmI0LWYzMWNhZDkxYzQ2MS5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwNzA3JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDcwN1QwMTE1MDVaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1jMjdmMDUyOWQ0ZGE2MjgxNTY5MmUwYTczZWViZDJkYmE5NDIxNzVmZTEwNDY4YmViYTM1MGIxZmU1N2IyN2I1JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.7EkS1RhCXCmuM87PWwc_wZK1eUO--OQkjKhORsWybOM" content-type-secured-asset="image/png" style="max-width: 100%; height: auto;"></a>

<strong>Complex Policy</strong>

|           | ns/op _default | ns/op _optimized | B/op _default | B/op _optimized | allocs/op _default | allocs/op _optimized |
|-----------|----------------|------------------|---------------|-----------------|--------------------|----------------------|
| Median    | 1021329        | 28488.5          | 832732        | 20386           | 13990              | 336                  |
| Average   | 1083208.684    | 29921.284        | 832734.342    | 20386.162       | 13990.147          | 336                  |
| P99       | 1612204.06     | 36141.25         | 832751        | 20388           | 13991              | 336                  |
| Max       | 2908902        | 53455            | 832797        | 20394           | 13991              | 336                  |
| Min       | 985625         | 26690            | 832726        | 20385           | 13990              | 336                  |
| Deviation | 140331.5701    | 3317.752934      | 7.238607147   | 1.144143813     | 0.3542831022       | 0                    |

Multiarch Docker image

Multiarch Docker image is available in Github's docker registry:

        docker run -it ghcr.io/zalando/skipper:v0.22.51 skipper --help

Docker image

Docker image is available in Zalando's Open Source registry:

        docker run -it registry.opensource.zalan.do/teapot/skipper:v0.22.51 skipper --help

