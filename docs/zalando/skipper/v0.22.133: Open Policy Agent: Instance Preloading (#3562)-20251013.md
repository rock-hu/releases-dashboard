# v0.22.133: Open Policy Agent: Instance Preloading (#3562)

## release on 20251013
## description
## changes
Overview

This feature implements issue <a class="issue-link js-issue-link" data-error-text="Failed to load title" data-id="3124049716" data-permission-text="Title is private" data-url="https://github.com/zalando/skipper/issues/3526" data-hovercard-type="issue" data-hovercard-url="/zalando/skipper/issues/3526/hovercard" href="https://github.com/zalando/skipper/issues/3526">#3526</a> by moving OPA instance startup and  

bundle downloading out of filter creation to make route processing  

faster and more reliable.

Problem

Previously, OPA filters created instances synchronously during filter  

creation, which:

* Blocked route processing during bundle downloads
* Could cause timeouts with large bundles or slow networks
* Violated the assumption that filter creation should be fast

Solution

When enabled via the <code>--enable-open-policy-agent-preloading</code> flag, OPA  

instances are pre-loaded during route processing instead of filter  

creation:

1. <strong>Route PreProcessor</strong>: Scans routes for OPA filter usage and  
   pre-creates instances
2. <strong>Loading Strategy</strong>: Parallel and blocking loading on startup,  
   sequential on route updates
3. <strong>Non-blocking Filter Creation</strong>: Filters only lookup created  
   instances, failing fast on a hard error
4. <strong>Filters Reflect Health</strong>: Filters return a 503 as long as an  
   instance is not yet healthy

Not that when Skipper starts, the PreProcessor blocks on the first  

invocation, guaranteeing that OPA instances have been tried to start.  

Only in steady state, when new routes introduce new OPA policies, can a  

503 occur temporarily. However since these are new routes, it would  

rather be odd for them to immediately receive traffic.

Without the flag, the behaviour stays unchanged.

Usage

Enable the Feature

    skipper --enable-open-policy-agent --enable-open-policy-agent-preloading

Configuration

* <code>--enable-open-policy-agent-preloading</code>: Enable the pre-loading  
  behavior (default: false)
* All existing OPA configuration flags remain the same

*** ** * ** ***

Signed-off-by: Magnus Jungsbluth <a href="mailto:magnus.jungsbluth@zalando.de">magnus.jungsbluth@zalando.de</a>  

Signed-off-by: Pushpalanka Jayawardhana <a href="mailto:pushpalankajaya@gmail.com">pushpalankajaya@gmail.com</a>  

Co-authored-by: Pushpalanka Jayawardhana <a href="mailto:pushpalankajaya@gmail.com">pushpalankajaya@gmail.com</a>  

Co-authored-by: Pushpalanka Jayawardhana <a href="mailto:pushpalanka.jayawardhana@zalando.de">pushpalanka.jayawardhana@zalando.de</a>

